---
- debug: msg="START resource manager persist on connection={{ ansible_connection }}"

- include_tasks: "includes/remove_config.yaml"

- block:
    - set_fact:
        expected_gathered_output:
          timer: 20
          holdtime: 10
          reinit: 3
          enabled: true

    - name: Merge provided configuration with device configuration
      register: result
      cisco.ios.ios_lldp_global:
        config:
          holdtime: 10
          enabled: true
          reinit: 3
          timer: 20
        state: merged

    - name: Get the supported resource modules
      ansible.netcommon.network_resource:
        os_name: "{{ ansible_network_os }}"
      register: network_resources_list

    - set_fact:
        resources: "{{ network_resources_list['modules'] }}"
      when: resources is undefined

    - set_fact:
        network_resources:
          actionable:
            - "lldp_global"

    - include_tasks: "./includes/build.yml"
      loop: "{{ network_resources['actionable'] }}"

    - name: Get list of files
      find:
        paths: "{{ inventory_directory }}/host_vars/{{ inventory_hostname }}"
        recurse: false
        patterns: "*.yaml"
        file_type: file
      register: found_directories

    - set_fact:
        res: "{{ found_directories.files[0] }}"

    - set_fact:
        name: "{{ ansible_network_os }}_{{ (res.path | basename).split('.') | first  }}"
        resource: "{{ (res.path | basename).split('.') | first  }}"
        lst: "{{ (res.path | basename).split('.') | first  }}"

    - name: Grab the resource facts
      include_vars:
        file: "{{ res.path }}"
        name: module_vars

    - name: Assert that before dicts are correctly generated
      assert:
        that:
          - "{{ module_vars[resource] == expected_gathered_output }}"
  always:

    - include_tasks: "includes/remove_config.yaml"

- debug: msg="STOP resource manager persist on connection={{ ansible_connection }}"
