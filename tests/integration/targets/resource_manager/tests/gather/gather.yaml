---
- debug: msg="START resource manager gather on connection={{ ansible_connection }}"
- include_tasks: "includes/remove_config.yaml"
- set_fact:
    expected_gathered_output:
      - name: GigabitEthernet0/1
        description: Configured and Merged by Ansible-Network
        mtu: 110
        enabled: true
        duplex: half

      - name: GigabitEthernet0/2
        description: Configured and Merged by Ansible-Network
        mtu: 2800
        enabled: false
        speed: 100
        duplex: full

- name: Merge provided configuration with device configuration
  register: result
  cisco.ios.ios_interfaces: &id001
    config:

      - name: GigabitEthernet0/1
        description: Configured and Merged by Ansible-Network
        mtu: 110
        enabled: true
        duplex: half

      - name: GigabitEthernet0/2
        description: Configured and Merged by Ansible-Network
        mtu: 2800
        enabled: false
        speed: 100
        duplex: full
    state: merged

- name: Get the supported resource modules
  ansible.netcommon.network_resource:
    os_name: "{{ ansible_network_os }}"
  register: network_resources_list

- set_fact:
    resources: "{{ network_resources_list['modules'] }}"
  when: resources is undefined

- set_fact:
    network_resources:
      actionable:
        - "interfaces"

- include_tasks: "./includes/build.yml"
  loop: "{{ network_resources['actionable'] }}"
# - name: Assert that before dicts are correctly generated
#  assert:
#    that:
#      - "{{ result['gathered']['GigabitEthernet0/1'] | symmetric_difference(expected_gathered_output['GigabitEthernet0/1']) | length\
#        \ == 0 }}"
#
