---
- debug: msg="START resource manager deploy on connection={{ ansible_connection }}"

- name: Run the platform specific deploy task tests
  include_role:
    name: ansible.network.resource_manager
    tasks_from: deploy
  vars:
    inventory_directory: ./inventory
    resources:
      - 'lldp_global'
    state: merged
  with_first_found:
    - "deploy.yaml"
    - "includes/unsupported_task.yaml"

- include_tasks: "includes/remove_config.yaml"

- block:
    - set_fact:
        expected_gathered_output:
          legacy_protocols:
            - fdp
            - cdp
          address: 192.0.2.11

    - name: Merge provided configuration with device configuration
      register: result
      vyos.vyos.vyos_lldp_global:
        config:
          legacy_protocols:
            - fdp
            - cdp
          address: 192.0.2.11
        state: merged

    - name: Get the supported resource modules
      ansible.netcommon.network_resource:
        os_name: "{{ ansible_network_os }}"
      register: network_resources_list

    - set_fact:
        resources: "{{ network_resources_list['modules'] }}"
      when: resources is undefined

    - set_fact:
        network_resources:
          actionable:
            - "lldp_global"

    - include_tasks: "./includes/build.yml"
      loop: "{{ network_resources['actionable'] }}"

    - name: Get list of files
      find:
        paths: "{{ inventory_directory }}/host_vars/{{ inventory_hostname }}"
        recurse: false
        patterns: "*.yaml"
        file_type: file
      register: found_directories

    - set_fact:
        res: "{{ found_directories.files[0] }}"

    - set_fact:
        name: "{{ ansible_network_os }}_{{ (res.path | basename).split('.') | first  }}"
        resource: "{{ (res.path | basename).split('.') | first  }}"
        lst: "{{ (res.path | basename).split('.') | first  }}"

    - name: Grab the resource facts
      include_vars:
        file: "{{ res.path }}"
        name: module_vars

    - name: Merge provided configuration with device configuration
      register: result
      vyos.vyos.vyos_lldp_global:
        config:
          legacy_protocols:
            - fdp
            - cdp
          address: 192.0.2.12
        state: replaced

    - include_tasks: './includes/deploy.yaml'

    - name: Merge provided configuration with device configuration
      register: result
      vyos.vyos.vyos_lldp_global:
        state: gathered


    - name: Assert that before dicts are correctly generated
      assert:
        that:
          - "{{ result['gathered'] == expected_gathered_output }}"
  always:

    - include_tasks: "includes/remove_config.yaml"

- debug: msg="STOP resource manager deploy on connection={{ ansible_connection }}"
